/*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org *//*! screen-sharing-sample build:0.1.0, development. Copyright(C) 2013-2014 www.OpenFlint.org */(function() {
  var EventEmitter, FlintReceiverManager, WebSocketReadyState, alias, indexOfListener,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  indexOfListener = function(listeners, listener) {
    var i, _i, _ref;
    if (listeners.length > 0) {
      for (i = _i = 0, _ref = listeners.length - 1; 0 <= _ref ? _i <= _ref : _i >= _ref; i = 0 <= _ref ? ++_i : --_i) {
        if (listeners[i].listener === listener) {
          return i;
        }
      }
    }
    return -1;
  };

  alias = function(name) {
    return function() {
      return this[name].apply(this, arguments);
    };
  };

  EventEmitter = (function() {
    function EventEmitter() {}

    EventEmitter.prototype.getListeners = function(evt) {
      var events, key, response;
      events = this._getEvents();
      if (evt instanceof RegExp) {
        response = {};
        for (key in events) {
          if (events.hasOwnProperty(key) && evt.test(key)) {
            response[key] = events[key];
          }
        }
      } else {
        response = events[evt] || (events[evt] = []);
      }
      return response;
    };

    EventEmitter.prototype.flattenListeners = function(listeners) {
      var flatListeners, i;
      flatListeners = [];
      i = 0;
      while (i < listeners.length) {
        flatListeners.push(listeners[i].listener);
        i += 1;
      }
      return flatListeners;
    };

    EventEmitter.prototype.getListenersAsObject = function(evt) {
      var listeners, response;
      listeners = this.getListeners(evt);
      response = void 0;
      if (listeners instanceof Array) {
        response = {};
        response[evt] = listeners;
      }
      return response || listeners;
    };

    EventEmitter.prototype.addListener = function(evt, listener) {
      var key, listenerIsWrapped, listeners;
      listeners = this.getListenersAsObject(evt);
      listenerIsWrapped = typeof listener === "object";
      for (key in listeners) {
        if (listeners.hasOwnProperty(key) && indexOfListener(listeners[key], listener) === -1) {
          listeners[key].push((listenerIsWrapped ? listener : {
            listener: listener,
            once: false
          }));
        }
      }
      return this;
    };

    EventEmitter.prototype.on = alias("addListener");

    EventEmitter.prototype.addOnceListener = function(evt, listener) {
      return this.addListener(evt, {
        listener: listener,
        once: true
      });
    };

    EventEmitter.prototype.once = alias("addOnceListener");

    EventEmitter.prototype.defineEvent = function(evt) {
      this.getListeners(evt);
      return this;
    };

    EventEmitter.prototype.defineEvents = function(evts) {
      var i;
      i = 0;
      while (i < evts.length) {
        this.defineEvent(evts[i]);
        i += 1;
      }
      return this;
    };

    EventEmitter.prototype.removeListener = function(evt, listener) {
      var index, key, listeners;
      listeners = this.getListenersAsObject(evt);
      for (key in listeners) {
        if (listeners.hasOwnProperty(key)) {
          index = indexOfListener(listeners[key], listener);
          if (index !== -1) {
            listeners[key].splice(index, 1);
          }
        }
      }
      return this;
    };

    EventEmitter.prototype.off = alias("removeListener");

    EventEmitter.prototype.addListeners = function(evt, listeners) {
      return this.manipulateListeners(false, evt, listeners);
    };

    EventEmitter.prototype.removeListeners = function(evt, listeners) {
      return this.manipulateListeners(true, evt, listeners);
    };

    EventEmitter.prototype.manipulateListeners = function(remove, evt, listeners) {
      var i, multiple, single, value;
      value = void 0;
      single = (remove ? this.removeListener : this.addListener);
      multiple = (remove ? this.removeListeners : this.addListeners);
      if (typeof evt === "object" && (!(evt instanceof RegExp))) {
        for (i in evt) {
          if (evt.hasOwnProperty(i) && (value = evt[i])) {
            if (typeof value === "function") {
              single.call(this, i, value);
            } else {
              multiple.call(this, i, value);
            }
          }
        }
      } else {
        i = listeners.length;
        while (i--) {
          single.call(this, evt, listeners[i]);
        }
      }
      return this;
    };

    EventEmitter.prototype.removeEvent = function(evt) {
      var events, key, type;
      type = typeof evt;
      events = this._getEvents();
      if (type === "string") {
        delete events[evt];
      } else if (evt instanceof RegExp) {
        for (key in events) {
          if (events.hasOwnProperty(key) && evt.test(key)) {
            delete events[key];
          }
        }
      } else {
        delete this._events;
      }
      return this;
    };

    EventEmitter.prototype.removeAllListeners = alias("removeEvent");

    EventEmitter.prototype.emitEvent = function(evt, args) {
      var i, key, listener, listeners, response;
      listeners = this.getListenersAsObject(evt);
      for (key in listeners) {
        if (listeners.hasOwnProperty(key)) {
          i = listeners[key].length;
          while (i--) {
            listener = listeners[key][i];
            if (listener.once === true) {
              this.removeListener(evt, listener.listener);
            }
            response = listener.listener.apply(this, args || []);
            if (response === this._getOnceReturnValue()) {
              this.removeListener(evt, listener.listener);
            }
          }
        }
      }
      return this;
    };

    EventEmitter.prototype.trigger = alias("emitEvent");

    EventEmitter.prototype.emit = function(evt) {
      var args;
      args = Array.prototype.slice.call(arguments, 1);
      return this.emitEvent(evt, args);
    };

    EventEmitter.prototype.setOnceReturnValue = function(value) {
      this._onceReturnValue = value;
      return this;
    };

    EventEmitter.prototype._getOnceReturnValue = function() {
      if (this.hasOwnProperty("_onceReturnValue")) {
        return this._onceReturnValue;
      } else {
        return true;
      }
    };

    EventEmitter.prototype._getEvents = function() {
      return this._events || (this._events = {});
    };

    return EventEmitter;

  })();

  WebSocketReadyState = (function() {
    function WebSocketReadyState() {}

    WebSocketReadyState.CONNECTING = 0;

    WebSocketReadyState.OPEN = 1;

    WebSocketReadyState.CLOSING = 2;

    WebSocketReadyState.CLOSED = 3;

    return WebSocketReadyState;

  })();

  FlintReceiverManager = (function(_super) {
    __extends(FlintReceiverManager, _super);

    function FlintReceiverManager(appId) {
      this.appId = appId;
      this.wsconn = null;
      this.wsServer = "ws://localhost:9431/receiver/" + this.appId;
    }

    FlintReceiverManager.prototype.start = function(additionalData) {
      var _ref, _ref1;
      if (((_ref = this.wsconn) != null ? _ref.readyState : void 0) === WebSocketReadyState.CONNECTING) {
        return;
      }
      if (((_ref1 = this.wsconn) != null ? _ref1.readyState : void 0) === WebSocketReadyState.OPEN) {
        return;
      }
      this.additionalData = additionalData;
      this.wsconn = new WebSocket(this.wsServer);
      this.wsconn.onopen = (function(_this) {
        return function(evt) {
          return _this._onOpen(evt);
        };
      })(this);
      this.wsconn.onclose = (function(_this) {
        return function(evt) {
          return console.info("----------------------------------------------->flingd onclose....");
        };
      })(this);
      this.wsconn.onmessage = (function(_this) {
        return function(evt) {
          console.info("----------------------------------------------->flingd onmessage....", evt.data);
          if (evt.data) {
            return _this._onMessage(JSON.parse(evt.data));
          }
        };
      })(this);
      return this.wsconn.onerror = (function(_this) {
        return function(evt) {
          console.info("----------------------------------------------->flingd onerror....", evt);
          return _this._onError({
            message: "Underlying websocket is not open",
            socketReadyState: evt.target.readyState
          });
        };
      })(this);
    };

    FlintReceiverManager.prototype.setAdditionalData = function(additionalData) {
      this.additionalData = additionalData;
      return this.send({
        type: "additionaldata",
        additionaldata: this.additionalData
      });
    };

    FlintReceiverManager.prototype.send = function(data) {
      var _ref, _ref1;
      data["appid"] = this.appId;
      data = JSON.stringify(data);
      console.info("----------------------------------------------->flingd send....", data);
      if (((_ref = this.wsconn) != null ? _ref.readyState : void 0) === WebSocketReadyState.OPEN) {
        return this.wsconn.send(data);
      } else if (((_ref1 = this.ws) != null ? _ref1.readyState : void 0) === WebSocketReadyState.CONNECTING) {
        return setTimeout(((function(_this) {
          return function() {
            return _this.send(data);
          };
        })(this)), 50);
      } else {
        return this._onError({
          message: "Underlying websocket is not open",
          socketReadyState: WebSocketReadyState.CLOSED
        });
      }
    };

    FlintReceiverManager.prototype._onError = function(event) {
      return this.emit("error", event);
    };

    FlintReceiverManager.prototype._onOpen = function() {
      return this.send({
        type: "register"
      });
    };

    FlintReceiverManager.prototype._onSenderConnected = function(data) {};

    FlintReceiverManager.prototype._onSenderDisconnected = function(data) {};

    FlintReceiverManager.prototype._onMessage = function(data) {
      console.error("_onMessage", data);
      switch (data != null ? data.type : void 0) {
        case 'startheartbeat':
          return console.log('startheartbeat');
        case 'registerok':
          this.localIpAddress = data["service_info"]["ip"][0];
          this.uuid = data["service_info"]["uuid"];
          this.deviceName = data["service_info"]["device_name"];
          console.info("=========================================>flingd has onopened: ", (__indexOf.call(self, "onopend") >= 0));
          this.send({
            type: "additionaldata",
            additionaldata: this.additionalData
          });
          return this.emit('ready');
        case 'heartbeat':
          if (data.heartbeat === 'ping') {
            return this.send({
              type: 'heartbeat',
              heartbeat: 'pong'
            });
          } else {
            return this.send({
              type: 'heartbeat',
              heartbeat: 'ping'
            });
          }
          break;
        case "senderconnected":
          return this._onSenderConnected(data);
        case "senderdisconnected":
          return this._onSenderDisconnected(data);
        default:
          return this.emit('message', data);
      }
    };

    return FlintReceiverManager;

  })(EventEmitter);

  this.FlintReceiverManager = FlintReceiverManager;

}).call(this);
